name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  backend-tests:
    name: Backend Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Node 18+ provides globalThis.crypto.getRandomValues nativement,
        # ce qui √©vite les erreurs de d√©marrage de Vitest/Vite.
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend tests
        working-directory: backend
        run: npm run test:ci

      - name: Upload test coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  frontend-smoke:
    name: Frontend Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Verify frontend can serve assets
        working-directory: frontend
        env:
          FRONTEND_PORT: 8080
        run: |
          npm run start >/tmp/frontend.log 2>&1 &
          FRONT_PID=$!
          cleanup() {
            kill $FRONT_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          sleep 5
          curl -f "http://127.0.0.1:${FRONTEND_PORT}" >/dev/null

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Validate package.json files
        run: |
          node -e "JSON.parse(require('fs').readFileSync('backend/package.json', 'utf8'))"
          node -e "JSON.parse(require('fs').readFileSync('frontend/package.json', 'utf8'))"

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend audit
        working-directory: backend
        run: npm audit --audit-level=high

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend audit
        working-directory: frontend
        run: npm audit --audit-level=high

  runtime-check:
    name: Runtime Smoke Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-smoke, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Backend health script
        working-directory: backend
        env:
          NODE_ENV: production
        run: |
          npm run start >/tmp/backend.log 2>&1 &
          BACKEND_PID=$!
          cleanup() {
            kill $BACKEND_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          sleep 5
          npm run test:health

      - name: Frontend availability check
        working-directory: frontend
        env:
          FRONTEND_PORT: 8080
        run: |
          npm run start >/tmp/frontend.log 2>&1 &
          FRONT_PID=$!
          cleanup() {
            kill $FRONT_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          sleep 3
          curl -f "http://127.0.0.1:${FRONTEND_PORT}" >/dev/null

  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: [runtime-check, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.backend
          push: false
          tags: sedi-tablette-backend:${{ github.sha }}

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.frontend
          push: false
          tags: sedi-tablette-frontend:${{ github.sha }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-smoke, lint, security, runtime-check, docker-build]
    if: always()
    steps:
      - name: Notify Success
        if: ${{ needs.backend-tests.result == 'success' && needs.frontend-smoke.result == 'success' && needs.lint.result == 'success' && needs.security.result == 'success' && needs.runtime-check.result == 'success' && needs.docker-build.result == 'success' }}
        run: |
          echo "‚úÖ All checks passed successfully!"
          echo "üéâ CI/CD Pipeline completed successfully"

      - name: Notify Failure
        if: ${{ needs.backend-tests.result == 'failure' || needs.frontend-smoke.result == 'failure' || needs.lint.result == 'failure' || needs.security.result == 'failure' || needs.runtime-check.result == 'failure' || needs.docker-build.result == 'failure' }}
        run: |
          echo "‚ùå Some checks failed:"
          echo "Backend tests: ${{ needs.backend-tests.result }}"
          echo "Frontend smoke: ${{ needs.frontend-smoke.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Runtime check: ${{ needs.runtime-check.result }}"
          echo "Docker build: ${{ needs.docker-build.result }}"
          exit 1

  deploy:
    name: Deploy to serveurproduction
    runs-on: [self-hosted, Linux, X64]
    needs: [docker-build, notify]
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout workflow files
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          port: ${{ secrets.PROD_PORT }}
          key: ${{ secrets.PROD_SSH_KEY }}
          passphrase: ${{ secrets.PROD_SSH_PASSPHRASE }}
          script: |
            cd tablette_better

            PASS='${{ secrets.PROD_SUDO_PASS }}'
            runsudo() {
              echo "$PASS" | sudo -S "$@"
            }

            echo "üì¶ Gestion des modifications locales..."
            git stash || true
            git pull
            git stash pop || true

            echo "üöÄ D√©ploiement orchestr√©..."
            runsudo chmod +x docker/deploy.sh
            runsudo COMPOSE_PROJECT=sedi-tablette NETWORK_NAME=sedi-tablette-network ./docker/deploy.sh

            echo "‚úÖ V√©rification des conteneurs..."
            runsudo docker ps --filter "name=sedi-"